import sys, csv
from PyQt6.QtWidgets import (
    QApplication, QMainWindow, QPushButton, QVBoxLayout, QWidget, QHBoxLayout,
    QLabel, QComboBox, QTableWidget, QFileDialog, QMessageBox, QTableWidgetItem
)
from PyQt6.QtGui import QColor


class OlympiadViewer(QMainWindow):
    def __init__(self):
        super().__init__()
        self.records, self.filtered_records = [], []
        self.school_set, self.class_set = set(), set()
        self.setup_ui()

    def setup_ui(self):
        self.setWindowTitle('Олимпиада: просмотр и фильтрация')
        main_layout = QVBoxLayout(self)
        container = QWidget()
        container.setLayout(main_layout)
        self.setCentralWidget(container)

        load_button = QPushButton("Открыть CSV")
        load_button.clicked.connect(self.load_csv_dialog)
        main_layout.addWidget(load_button)

        filter_bar = QHBoxLayout()
        self.school_selector = QComboBox()
        self.school_selector.addItem("Все школы")
        self.school_selector.currentTextChanged.connect(self.filter_records)
        filter_bar.addWidget(QLabel("Школа:"))
        filter_bar.addWidget(self.school_selector)

        self.class_selector = QComboBox()
        self.class_selector.addItem("Все классы")
        self.class_selector.currentTextChanged.connect(self.filter_records)
        filter_bar.addWidget(QLabel("Класс:"))
        filter_bar.addWidget(self.class_selector)

        clear_button = QPushButton("Сбросить")
        clear_button.clicked.connect(self.reset_filters)
        filter_bar.addWidget(clear_button)
        filter_bar.addStretch()
        main_layout.addLayout(filter_bar)

        self.result_table = QTableWidget()
        self.result_table.setColumnCount(3)
        self.result_table.setHorizontalHeaderLabels(["Логин", "ФИО", "Баллы"])
        main_layout.addWidget(self.result_table)

    def load_csv_dialog(self):
        path, _ = QFileDialog.getOpenFileName(self, "Выберите CSV", "", "CSV Files (*.csv)")
        if path:
            try:
                self.parse_csv(path)
                self.filter_records()
                self.statusBar().showMessage(f"Загружено: {path}")
            except Exception as err:
                QMessageBox.critical(self, "Ошибка", f"Не удалось загрузить: {str(err)}")

    def parse_csv(self, path):
        self.records.clear(), self.school_set.clear(), self.class_set.clear()
        with open(path, 'r', encoding='utf-8') as f:
            reader = csv.reader(f)
            next(reader)
            for line_num, row in enumerate(reader):
                if len(row) < 8: continue
                try:
                    login = row[2].strip()
                    score = int(row[7].strip()) if row[7].strip().isdigit() else 0
                    parts = login.split('-')
                    school_id = parts[3] if len(parts) >= 5 else "unknown"
                    class_id = parts[4] if len(parts) >= 5 else "unknown"
                    self.records.append({
                        'place': row[0].strip(),
                        'name': row[1].strip(),
                        'login': login,
                        'school': school_id,
                        'class': class_id,
                        'score': score
                    })
                    self.school_set.add(school_id)
                    self.class_set.add(class_id)
                except Exception as err:
                    print(f"Ошибка в строке {line_num + 2}: {row} - {err}")
        self.refresh_filters()

    def refresh_filters(self):
        s, c = self.school_selector.currentText(), self.class_selector.currentText()
        self.school_selector.clear()
        self.school_selector.addItem("Все школы")
        self.school_selector.addItems(sorted(self.school_set))
        if s in self.school_set: self.school_selector.setCurrentText(s)

        self.class_selector.clear()
        self.class_selector.addItem("Все классы")
        self.class_selector.addItems(sorted(self.class_set))
        if c in self.class_set: self.class_selector.setCurrentText(c)

    def filter_records(self):
        s, c = self.school_selector.currentText(), self.class_selector.currentText()
        self.filtered_records = [r for r in self.records if
                                 (s == "Все школы" or r['school'] == s) and
                                 (c == "Все классы" or r['class'] == c)]
        self.filtered_records.sort(key=lambda r: r['score'], reverse=True)
        self.assign_places()
        self.populate_table()

    def assign_places(self):
        if not self.filtered_records: return
        place, last_score = 1, self.filtered_records[0]['score']
        for i, r in enumerate(self.filtered_records):
            if r['score'] < last_score:
                place = i + 1
                last_score = r['score']
            r['rank'] = place

    def populate_table(self):
        self.result_table.setRowCount(len(self.filtered_records))
        self.result_table.clearContents()
        top_scores = sorted({r['score'] for r in self.filtered_records}, reverse=True)[:3]
        for row, r in enumerate(self.filtered_records):
            self.result_table.setItem(row, 0, QTableWidgetItem(r['login']))
            self.result_table.setItem(row, 1, QTableWidgetItem(r['name']))
            self.result_table.setItem(row, 2, QTableWidgetItem(str(r['score'])))
            if r['score'] == top_scores[0]:
                self.color_row(row, QColor(255, 215, 0))
            elif len(top_scores) > 1 and r['score'] == top_scores[1]:
                self.color_row(row, QColor(192, 192, 192))
            elif len(top_scores) > 2 and r['score'] == top_scores[2]:
                self.color_row(row, QColor(205, 127, 50))

    def color_row(self, row, color):
        for col in range(self.result_table.columnCount()):
            item = self.result_table.item(row, col)
            if item:
                item.setBackground(color)

    def reset_filters(self):
        self.school_selector.setCurrentIndex(0)
        self.class_selector.setCurrentIndex(0)


def main():
    app = QApplication(sys.argv)
    viewer = OlympiadViewer()
    viewer.show()
    sys.exit(app.exec())


if __name__ == "__main__":
    main()
